import React, { useState, useEffect, useRef } from 'react';
import { Shuffle, BookOpen, RotateCcw, Trophy, Check, X, HelpCircle, Keyboard, ArrowRight, Volume2, VolumeX, Link, Gamepad2, Brain, Layers, Target, FileType } from 'lucide-react';

// --- D·ªÆ LI·ªÜU T·ª™ V·ª∞NG ---
const rawData = [
  { id: 1, en: "terrace", vi: "s√¢n th∆∞·ª£ng", pos: "noun (danh t·ª´)" },
  { id: 2, en: "gourmet", vi: "s√†nh ƒÉn", pos: "adj (t√≠nh t·ª´)" },
  { id: 3, en: "suitcase", vi: "va li", pos: "noun (danh t·ª´)" },
  { id: 4, en: "cupboard", vi: "c√°i t·ªß ƒë·∫ßu gi∆∞·ªùng", pos: "noun (danh t·ª´)" },
  { id: 5, en: "petrol station", vi: "tr·∫°m ƒë·ªï xƒÉng", pos: "noun (danh t·ª´)" },
  { id: 6, en: "station", vi: "ga t√†u", pos: "noun (danh t·ª´)" },
  { id: 7, en: "pray", vi: "c·∫ßu nguy·ªán", pos: "verb (ƒë·ªông t·ª´)" },
  { id: 8, en: "letters", vi: "l√° th∆∞", pos: "noun (danh t·ª´)" },
  { id: 9, en: "medicine", vi: "thu·ªëc", pos: "noun (danh t·ª´)" },
  { id: 10, en: "mayor", vi: "th·ªã tr∆∞·ªüng", pos: "noun (danh t·ª´)" },
  { id: 11, en: "rent", vi: "thu√™", pos: "verb (ƒë·ªông t·ª´)" },
  { id: 12, en: "interval", vi: "kho·∫£ng ngh·ªâ", pos: "noun (danh t·ª´)" },
  { id: 13, en: "perfume", vi: "n∆∞·ªõc hoa", pos: "noun (danh t·ª´)" },
  { id: 14, en: "property", vi: "l√†m v·ªÅ nh√† ƒë·∫•t / t√†i s·∫£n", pos: "noun (danh t·ª´)" },
  { id: 15, en: "thick", vi: "d√†y", pos: "adj (t√≠nh t·ª´)" },
  { id: 16, en: "hard", vi: "c·ª©ng / kh√≥", pos: "adj (t√≠nh t·ª´)" },
  { id: 17, en: "scooter", vi: "xe c·ª° nh·ªè / xe ga", pos: "noun (danh t·ª´)" },
  { id: 18, en: "awful", vi: "t·ªìi t·ªá", pos: "adj (t√≠nh t·ª´)" },
  { id: 19, en: "big pot of coffee", vi: "m·ªôt ·∫•m c√† ph√™ l·ªõn", pos: "noun phrase (c·ª•m danh t·ª´)" }
];

// --- T√ÄI NGUY√äN √ÇM THANH ---
const MUSIC_URL = "https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-664.mp3";
const SFX_CORRECT = "https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3";
const SFX_WRONG = "https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3";
const SFX_CLICK = "https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3";
const SFX_WIN = "https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3";

// --- COMPONENT CH√çNH ---
export default function App() {
  const [mode, setMode] = useState('menu');
  const [isMusicPlaying, setIsMusicPlaying] = useState(false);
  const audioRef = useRef(null);

  // Th√™m CSS ƒë·ªông cho hi·ªáu ·ª©ng l·∫≠t th·∫ª v√† rung
  useEffect(() => {
    const style = document.createElement('style');
    style.innerHTML = `
      .perspective-1000 { perspective: 1000px; }
      .transform-style-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: hidden; }
      .rotate-y-180 { transform: rotateY(180deg); }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
      @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
      .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
      @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
      .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    `;
    document.head.appendChild(style);
    return () => {
      document.head.removeChild(style);
    };
  }, []);

  // Kh·ªüi t·∫°o nh·∫°c n·ªÅn
  useEffect(() => {
    audioRef.current = new Audio(MUSIC_URL);
    audioRef.current.loop = true;
    audioRef.current.volume = 0.2;
    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  const toggleMusic = () => {
    if (!audioRef.current) return;
    if (isMusicPlaying) {
      audioRef.current.pause();
      setIsMusicPlaying(false);
    } else {
      audioRef.current.play().catch(e => console.log("L·ªói ph√°t nh·∫°c:", e));
      setIsMusicPlaying(true);
    }
  };

  const playSfx = (type) => {
    let url = "";
    switch (type) {
      case 'correct': url = SFX_CORRECT; break;
      case 'wrong': url = SFX_WRONG; break;
      case 'click': url = SFX_CLICK; break;
      case 'win': url = SFX_WIN; break;
      default: return;
    }
    const audio = new Audio(url);
    audio.volume = 0.5;
    audio.play().catch(() => {});
  };

  return (
    <div className="min-h-screen bg-slate-100 text-slate-800 font-sans selection:bg-indigo-200">
      <div className="max-w-4xl mx-auto min-h-screen flex flex-col bg-white shadow-2xl overflow-hidden">
        
        {/* Header */}
        <header className="bg-slate-900 text-white p-4 md:p-6 flex justify-between items-center shadow-md z-10">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-indigo-600 rounded-lg">
              <Trophy className="w-6 h-6 text-yellow-300" />
            </div>
            <h1 className="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
              Vocabulary Quiz Show
            </h1>
          </div>
          
          <div className="flex items-center gap-3">
            <button 
              onClick={toggleMusic}
              className={`p-2 rounded-full transition ${isMusicPlaying ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400 hover:text-white'}`}
              title={isMusicPlaying ? "T·∫Øt nh·∫°c" : "B·∫≠t nh·∫°c"}
            >
              {isMusicPlaying ? <Volume2 size={20} /> : <VolumeX size={20} />}
            </button>

            {mode !== 'menu' && (
              <button 
                onClick={() => { playSfx('click'); setMode('menu'); }}
                className="flex items-center gap-2 text-xs md:text-sm bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition font-medium"
              >
                <RotateCcw size={16} />
                <span className="hidden sm:inline">Trang ch·ªß</span>
              </button>
            )}
          </div>
        </header>

        {/* Body */}
        <main className="flex-1 p-4 md:p-8 bg-slate-50 overflow-y-auto">
          <div className="max-w-3xl mx-auto">
            {mode === 'menu' && <Menu setMode={setMode} playSfx={playSfx} />}
            {mode === 'study' && <StudyMode data={rawData} playSfx={playSfx} />}
            {mode === 'memory' && <MemoryGameMode data={rawData} playSfx={playSfx} />}
            {mode === 'match' && <MatchMode data={rawData} playSfx={playSfx} />}
            {mode === 'quiz' && <QuizMode data={rawData} playSfx={playSfx} />}
            {mode === 'typing' && <TypingMode data={rawData} playSfx={playSfx} />}
          </div>
        </main>

        {/* Footer */}
        <footer className="bg-white p-4 text-center text-slate-400 text-xs border-t border-slate-100">
          ¬© 2025 Vocabulary Game Challenge
        </footer>
      </div>
    </div>
  );
}

// --- C√ÅC COMPONENT CON ---

function Menu({ setMode, playSfx }) {
  const menuItems = [
    { id: 'study', title: 'H·ªçc Flashcard', desc: 'C√≥ ph√°t √¢m & lo·∫°i t·ª´', icon: <BookOpen size={28} />, color: 'indigo' },
    { id: 'memory', title: 'Gh√©p Th·∫ª Nh·ªõ', desc: 'L·∫≠t h√¨nh t√¨m c·∫∑p gi·ªëng nhau', icon: <Brain size={28} />, color: 'emerald' },
    { id: 'match', title: 'N·ªëi T·ª´', desc: 'N·ªëi t·ª´ Anh v·ªõi nghƒ©a Vi·ªát', icon: <Link size={28} />, color: 'sky' },
    { id: 'quiz', title: 'Tr·∫Øc Nghi·ªám', desc: 'Ch·ªçn 1 ƒë√°p √°n ƒë√∫ng trong 4', icon: <HelpCircle size={28} />, color: 'orange' },
    { id: 'typing', title: 'Luy·ªán G√µ', desc: 'G√µ l·∫°i t·ª´ ti·∫øng Anh', icon: <Keyboard size={28} />, color: 'rose' },
  ];

  return (
    <div className="animate-fade-in space-y-8">
      <div className="text-center space-y-2 mb-8">
        <h2 className="text-3xl md:text-4xl font-bold text-slate-800">S√†n ƒë·∫•u t·ª´ v·ª±ng</h2>
        <p className="text-slate-500 text-lg">Ch·ªçn th·ª≠ th√°ch c·ªßa b·∫°n!</p>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => { playSfx('click'); setMode(item.id); }}
            className={`group relative overflow-hidden bg-white border-2 p-6 rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 text-left flex items-start gap-4
              ${item.color === 'indigo' ? 'border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50' : ''}
              ${item.color === 'emerald' ? 'border-emerald-100 hover:border-emerald-500 hover:bg-emerald-50' : ''}
              ${item.color === 'sky' ? 'border-sky-100 hover:border-sky-500 hover:bg-sky-50' : ''}
              ${item.color === 'orange' ? 'border-orange-100 hover:border-orange-500 hover:bg-orange-50' : ''}
              ${item.color === 'rose' ? 'border-rose-100 hover:border-rose-500 hover:bg-rose-50' : ''}
            `}
          >
            <div className={`p-3 rounded-xl text-white transition-transform group-hover:scale-110 shadow-md
               ${item.color === 'indigo' ? 'bg-indigo-500' : ''}
               ${item.color === 'emerald' ? 'bg-emerald-500' : ''}
               ${item.color === 'sky' ? 'bg-sky-500' : ''}
               ${item.color === 'orange' ? 'bg-orange-500' : ''}
               ${item.color === 'rose' ? 'bg-rose-500' : ''}
            `}>
              {item.icon}
            </div>
            <div>
              <h3 className="font-bold text-lg text-slate-800">{item.title}</h3>
              <p className="text-slate-500 text-sm">{item.desc}</p>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
}

function StudyMode({ data, playSfx }) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);

  const currentWord = data[currentIndex];

  const nextCard = () => {
    playSfx('click');
    setIsFlipped(false);
    setTimeout(() => setCurrentIndex((prev) => (prev + 1) % data.length), 200);
  };

  const prevCard = () => {
    playSfx('click');
    setIsFlipped(false);
    setTimeout(() => setCurrentIndex((prev) => (prev - 1 + data.length) % data.length), 200);
  };

  const handleFlip = () => {
    playSfx('click');
    setIsFlipped(!isFlipped);
  };

  const handleSpeak = (e, text) => {
    e.stopPropagation();
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    } else {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc.");
    }
  };

  return (
    <div className="flex flex-col items-center justify-center h-full animate-fade-in">
      <div className="mb-6 text-center">
        <h2 className="text-2xl font-bold text-indigo-900">H·ªçc t·ª´ v·ª±ng</h2>
        <p className="text-slate-500">Th·∫ª {currentIndex + 1}/{data.length}</p>
      </div>

      <div 
        className="relative w-full max-w-md h-80 perspective-1000 cursor-pointer group"
        onClick={handleFlip}
      >
        <div className={`relative w-full h-full transition-transform duration-500 transform-style-3d shadow-xl rounded-3xl ${isFlipped ? 'rotate-y-180' : ''}`}>
          
          {/* Front */}
          <div className="absolute w-full h-full bg-white rounded-3xl backface-hidden flex flex-col items-center justify-center border-2 border-indigo-100 p-8 text-center">
            <span className="absolute top-6 left-6 text-xs uppercase tracking-wider text-slate-400 font-bold">Ti·∫øng Anh</span>
            <h3 className="text-4xl font-bold text-indigo-700 break-words max-w-full">{currentWord.en}</h3>
            <p className="text-indigo-400 mt-2 text-sm">Ch·∫°m ƒë·ªÉ xem nghƒ©a</p>
            
            <button 
              onClick={(e) => handleSpeak(e, currentWord.en)}
              className="absolute bottom-6 right-6 w-12 h-12 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center transition shadow-sm hover:scale-110 z-10"
              title="Nghe ph√°t √¢m"
            >
              <Volume2 size={24} />
            </button>
          </div>

          {/* Back */}
          <div className="absolute w-full h-full bg-indigo-600 rounded-3xl backface-hidden rotate-y-180 flex flex-col items-center justify-center text-white p-8 text-center">
            <span className="absolute top-6 left-6 text-xs uppercase tracking-wider text-indigo-200 font-bold">Ti·∫øng Vi·ªát</span>
            <span className="inline-block px-3 py-1 bg-indigo-500/50 rounded-full text-xs font-mono mb-4 border border-indigo-400/50">
              {currentWord.pos}
            </span>
            <h3 className="text-3xl font-bold mb-2">{currentWord.vi}</h3>
          </div>

        </div>
      </div>

      <div className="flex gap-4 mt-8 w-full max-w-md">
        <button onClick={prevCard} className="flex-1 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition">
          Quay l·∫°i
        </button>
        <button onClick={nextCard} className="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">
          Ti·∫øp theo
        </button>
      </div>
    </div>
  );
}

function MemoryGameMode({ data, playSfx }) {
  const [cards, setCards] = useState([]);
  const [flipped, setFlipped] = useState([]);
  const [matched, setMatched] = useState([]);
  const [moves, setMoves] = useState(0);
  const [won, setWon] = useState(false);

  useEffect(() => startNewGame(), []);

  const startNewGame = () => {
    const subset = [...data].sort(() => 0.5 - Math.random()).slice(0, 6);
    const deck = subset.flatMap(item => [
      { id: item.id, content: item.en, type: 'en', key: `${item.id}-en` },
      { id: item.id, content: item.vi, type: 'vi', key: `${item.id}-vi` }
    ]).sort(() => 0.5 - Math.random());
    
    setCards(deck);
    setFlipped([]);
    setMatched([]);
    setMoves(0);
    setWon(false);
  };

  const handleClick = (card) => {
    if (won || flipped.length >= 2 || flipped.includes(card) || matched.includes(card.id)) return;
    
    playSfx('click');
    const newFlipped = [...flipped, card];
    setFlipped(newFlipped);

    if (newFlipped.length === 2) {
      setMoves(m => m + 1);
      if (newFlipped[0].id === newFlipped[1].id) {
        playSfx('correct');
        setMatched(m => [...m, newFlipped[0].id]);
        setFlipped([]);
        
        if (matched.length + 1 === cards.length / 2) {
          setTimeout(() => {
            playSfx('win');
            setWon(true);
          }, 500);
        }
      } else {
        setTimeout(() => {
          playSfx('wrong');
          setFlipped([]);
        }, 1000);
      }
    }
  };

  return (
    <div className="animate-fade-in">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-xl font-bold text-emerald-800">L·∫≠t h√¨nh t√¨m c·∫∑p</h2>
        <div className="flex gap-4 text-sm font-medium">
          <span className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg">S·ªë l∆∞·ª£t: {moves}</span>
          <button onClick={() => { playSfx('click'); startNewGame();}} className="text-emerald-600 flex gap-1 items-center hover:underline">
            <RotateCcw size={14} /> Ch∆°i l·∫°i
          </button>
        </div>
      </div>

      <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
        {cards.map(card => {
          const isOpen = flipped.includes(card) || matched.includes(card.id);
          const isMatch = matched.includes(card.id);
          
          return (
            <div 
              key={card.key} 
              onClick={() => handleClick(card)}
              className={`aspect-[4/3] flex items-center justify-center text-center p-2 rounded-xl cursor-pointer transition-all duration-300 transform hover:scale-105 shadow-sm select-none text-sm md:text-base font-bold
                ${isMatch 
                  ? 'bg-emerald-100 text-emerald-700 border-2 border-emerald-200 opacity-60' 
                  : isOpen 
                    ? 'bg-emerald-600 text-white shadow-md rotate-y-0' 
                    : 'bg-white border-2 border-slate-200 text-transparent hover:border-emerald-200'
                }
              `}
            >
              <span className={isOpen ? 'block' : 'hidden'}>{card.content}</span>
            </div>
          );
        })}
      </div>

      {won && (
        <div className="mt-8 p-6 bg-emerald-50 border-2 border-emerald-100 rounded-2xl text-center animate-bounce-in">
          <Trophy className="w-12 h-12 text-yellow-500 mx-auto mb-2" />
          <h3 className="text-2xl font-bold text-emerald-700 mb-1">Chi·∫øn th·∫Øng!</h3>
          <p className="text-emerald-600 mb-4">B·∫°n ch·ªâ m·∫•t {moves} l∆∞·ª£t ƒë·ªÉ ho√†n th√†nh.</p>
          <button 
            onClick={() => { playSfx('click'); startNewGame();}}
            className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-200"
          >
            Ch∆°i v√°n m·ªõi
          </button>
        </div>
      )}
    </div>
  );
}

function MatchMode({ data, playSfx }) {
  const [leftItems, setLeftItems] = useState([]);
  const [rightItems, setRightItems] = useState([]);
  const [selected, setSelected] = useState(null);
  const [matched, setMatched] = useState([]);
  const [wrongPair, setWrongPair] = useState([]);
  const [won, setWon] = useState(false);

  useEffect(() => startNewGame(), []);

  const startNewGame = () => {
    const subset = [...data].sort(() => 0.5 - Math.random()).slice(0, 5);
    setLeftItems([...subset].sort(() => 0.5 - Math.random()));
    setRightItems([...subset].sort(() => 0.5 - Math.random()));
    setMatched([]);
    setSelected(null);
    setWrongPair([]);
    setWon(false);
  };

  const handleSelect = (item, side) => {
    if (matched.includes(item.id) || wrongPair.length > 0) return;
    playSfx('click');

    if (!selected) {
      setSelected({ id: item.id, side });
      return;
    }

    if (selected.id === item.id && selected.side === side) {
      setSelected(null);
      return;
    }

    if (selected.side === side) {
      setSelected({ id: item.id, side });
      return;
    }

    if (selected.id === item.id) {
      playSfx('correct');
      const newMatched = [...matched, item.id];
      setMatched(newMatched);
      setSelected(null);
      if (newMatched.length === leftItems.length) {
        setTimeout(() => { playSfx('win'); setWon(true); }, 500);
      }
    } else {
      playSfx('wrong');
      setWrongPair([selected.id, item.id]);
      setSelected(null);
      setTimeout(() => setWrongPair([]), 800);
    }
  };

  return (
    <div className="animate-fade-in h-full flex flex-col">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-sky-800">Gh√©p c·∫∑p ƒë√∫ng</h2>
        <button onClick={() => { playSfx('click'); startNewGame();}} className="text-sky-600 font-bold flex gap-2 items-center text-sm hover:bg-sky-50 px-3 py-1 rounded-lg transition">
          <RotateCcw size={16} /> ƒê·ªïi t·ª´ kh√°c
        </button>
      </div>

      <div className="grid grid-cols-2 gap-8 flex-1">
        <div className="flex flex-col gap-3">
          {leftItems.map(item => {
            const isMatched = matched.includes(item.id);
            const isSelected = selected?.id === item.id && selected?.side === 'left';
            const isWrong = wrongPair.includes(item.id) && !isMatched;
            return (
              <button
                key={`l-${item.id}`}
                onClick={() => handleSelect(item, 'left')}
                disabled={isMatched}
                className={`
                  p-3 md:p-4 rounded-xl border-2 text-center font-medium transition-all duration-300 relative
                  ${isMatched ? 'opacity-0 pointer-events-none translate-x-full' : 'opacity-100'}
                  ${isSelected ? 'bg-sky-100 border-sky-500 text-sky-800 scale-105 shadow-md z-10' : 'bg-white border-slate-200 hover:border-sky-300 text-slate-700'}
                  ${isWrong ? 'animate-shake bg-red-50 border-red-400 text-red-600' : ''}
                `}
              >
                {item.en}
              </button>
            );
          })}
        </div>
        <div className="flex flex-col gap-3">
          {rightItems.map(item => {
            const isMatched = matched.includes(item.id);
            const isSelected = selected?.id === item.id && selected?.side === 'right';
            const isWrong = wrongPair.includes(item.id) && !isMatched;
            return (
              <button
                key={`r-${item.id}`}
                onClick={() => handleSelect(item, 'right')}
                disabled={isMatched}
                className={`
                  p-3 md:p-4 rounded-xl border-2 text-center font-medium transition-all duration-300
                  ${isMatched ? 'opacity-0 pointer-events-none -translate-x-full' : 'opacity-100'}
                  ${isSelected ? 'bg-sky-100 border-sky-500 text-sky-800 scale-105 shadow-md z-10' : 'bg-white border-slate-200 hover:border-sky-300 text-slate-700'}
                  ${isWrong ? 'animate-shake bg-red-50 border-red-400 text-red-600' : ''}
                `}
              >
                {item.vi}
              </button>
            );
          })}
        </div>
      </div>

      {won && (
        <div className="absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center z-20 rounded-xl">
          <div className="text-center p-8 animate-bounce-in">
            <Trophy className="w-16 h-16 text-sky-500 mx-auto mb-4" />
            <h3 className="text-3xl font-bold text-sky-800 mb-2">Xu·∫•t s·∫Øc!</h3>
            <p className="text-sky-600 mb-6">B·∫°n ƒë√£ n·ªëi ƒë√∫ng t·∫•t c·∫£ c√°c c·∫∑p.</p>
            <button 
              onClick={() => { playSfx('click'); startNewGame();}}
              className="px-8 py-3 bg-sky-600 text-white rounded-xl font-bold hover:bg-sky-700 transition shadow-xl"
            >
              Ch∆°i ti·∫øp
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

function QuizMode({ data, playSfx }) {
  const [currentQ, setCurrentQ] = useState(0);
  const [score, setScore] = useState(0);
  const [questions, setQuestions] = useState([]);
  const [selected, setSelected] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);
  const [finished, setFinished] = useState(false);

  useEffect(() => restartQuiz(), []);

  const restartQuiz = () => {
    const shuffled = [...data].sort(() => 0.5 - Math.random());
    const qs = shuffled.map(item => {
      const distractors = data.filter(d => d.id !== item.id).sort(() => 0.5 - Math.random()).slice(0, 3);
      const options = [...distractors, item].sort(() => 0.5 - Math.random());
      return { target: item, options };
    });
    setQuestions(qs);
    setCurrentQ(0);
    setScore(0);
    setSelected(null);
    setIsCorrect(null);
    setFinished(false);
  };

  const handleSelect = (option) => {
    if (selected) return;
    setSelected(option);
    const correct = option.id === questions[currentQ].target.id;
    setIsCorrect(correct);
    if (correct) {
      playSfx('correct');
      setScore(s => s + 1);
    } else {
      playSfx('wrong');
    }
  };

  const nextQuestion = () => {
    playSfx('click');
    if (currentQ + 1 < questions.length) {
      setCurrentQ(c => c + 1);
      setSelected(null);
      setIsCorrect(null);
    } else {
      playSfx('win');
      setFinished(true);
    }
  };

  if (questions.length === 0) return <div className="p-8 text-center">Loading...</div>;

  if (finished) return (
    <div className="text-center py-10 animate-fade-in">
      <div className="inline-block p-4 bg-orange-100 rounded-full mb-4">
        <Trophy className="w-12 h-12 text-orange-500" />
      </div>
      <h2 className="text-3xl font-bold text-slate-800 mb-2">K·∫øt qu·∫£ b√†i thi</h2>
      <p className="text-xl text-slate-600">B·∫°n ƒë√∫ng <span className="font-bold text-orange-600">{score}/{questions.length}</span> c√¢u.</p>
      
      <div className="w-full bg-slate-200 rounded-full h-4 mt-6 overflow-hidden">
        <div 
          className="bg-orange-500 h-4 rounded-full transition-all duration-1000"
          style={{ width: `${(score / questions.length) * 100}%` }}
        ></div>
      </div>

      <button 
        onClick={() => { playSfx('click'); restartQuiz();}}
        className="mt-8 w-full md:w-auto px-8 py-3 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-200"
      >
        L√†m l·∫°i b√†i thi
      </button>
    </div>
  );

  const q = questions[currentQ];

  return (
    <div className="animate-fade-in max-w-2xl mx-auto">
      <div className="flex justify-between items-center mb-6 text-sm font-medium text-slate-400">
        <span>C√¢u h·ªèi {currentQ + 1}/{questions.length}</span>
        <span>ƒêi·ªÉm: {score}</span>
      </div>

      <div className="bg-white p-6 md:p-8 rounded-2xl shadow-sm border-2 border-orange-100 mb-6 text-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-1 bg-slate-100">
          <div className="h-full bg-orange-500 transition-all duration-300" style={{ width: `${((currentQ) / questions.length) * 100}%` }}></div>
        </div>
        <h3 className="text-2xl md:text-3xl font-bold text-slate-800 mb-2">"{q.target.vi}"</h3>
        <p className="text-slate-500">Nghƒ©a ti·∫øng Anh l√† g√¨?</p>
      </div>

      <div className="grid grid-cols-1 gap-3">
        {q.options.map((opt) => {
          let btnClass = "p-4 rounded-xl border-2 font-medium transition-all text-left relative flex items-center justify-between ";
          if (selected) {
            if (opt.id === q.target.id) btnClass += "bg-green-100 border-green-500 text-green-800 shadow-inner ";
            else if (opt === selected && opt.id !== q.target.id) btnClass += "bg-red-100 border-red-500 text-red-800 shadow-inner ";
            else btnClass += "bg-slate-50 border-slate-100 opacity-50 ";
          } else {
            btnClass += "bg-white border-slate-200 hover:border-orange-300 hover:bg-orange-50 cursor-pointer hover:shadow-md hover:-translate-y-0.5 text-slate-700";
          }

          return (
            <button
              key={opt.id}
              onClick={() => handleSelect(opt)}
              className={btnClass}
              disabled={!!selected}
            >
              <span className="font-bold">{opt.en}</span>
              {selected && opt.id === q.target.id && <Check className="text-green-600" />}
              {selected && opt === selected && opt.id !== q.target.id && <X className="text-red-600" />}
            </button>
          );
        })}
      </div>

      {selected && (
        <div className="mt-6 flex justify-end animate-fade-in">
          <button 
            onClick={nextQuestion}
            className="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition flex items-center gap-2"
          >
            {currentQ + 1 === questions.length ? "Xem k·∫øt qu·∫£" : "C√¢u ti·∫øp theo"}
            <ArrowRight size={18} />
          </button>
        </div>
      )}
    </div>
  );
}

function TypingMode({ data, playSfx }) {
  const [queue, setQueue] = useState([]);
  const [input, setInput] = useState('');
  const [status, setStatus] = useState('waiting'); // waiting, correct, wrong, giveup
  const [showHint, setShowHint] = useState(false);
  const inputRef = useRef(null);

  useEffect(() => {
    setQueue([...data].sort(() => 0.5 - Math.random()).slice(0, 10));
  }, []);

  const currentWord = queue[0];

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!currentWord) return;
    
    if (input.trim().toLowerCase() === currentWord.en.toLowerCase()) {
      playSfx('correct');
      setStatus('correct');
      setTimeout(() => {
        setQueue(prev => prev.slice(1));
        setInput('');
        setStatus('waiting');
        setShowHint(false);
      }, 1000);
    } else {
      playSfx('wrong');
      setStatus('wrong');
    }
  };

  const handleGiveUp = () => {
    playSfx('click');
    setInput(currentWord.en);
    setStatus('giveup');
    setTimeout(() => {
      setQueue(prev => prev.slice(1));
      setInput('');
      setStatus('waiting');
      setShowHint(false);
    }, 1500);
  }

  if (queue.length === 0) return (
    <div className="text-center py-12 animate-fade-in">
      <div className="bg-rose-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
        <Check className="w-10 h-10 text-rose-500" />
      </div>
      <h2 className="text-3xl font-bold text-slate-800 mb-2">Ho√†n th√†nh!</h2>
      <p className="text-slate-500 mb-8">B·∫°n ƒë√£ luy·ªán g√µ h·∫øt b·ªô t·ª´ n√†y.</p>
      <button onClick={() => window.location.reload()} className="px-8 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition shadow-lg">
        V·ªÅ trang ch·ªß
      </button>
    </div>
  );

  return (
    <div className="max-w-lg mx-auto text-center animate-fade-in">
      <div className="mb-8">
        <h2 className="text-xl font-bold text-rose-600 mb-1">Th·ª≠ th√°ch ch√≠nh t·∫£</h2>
        <p className="text-slate-400 text-sm">C√≤n l·∫°i: {queue.length} t·ª´</p>
      </div>

      <div className="bg-white p-8 rounded-2xl shadow-lg border-2 border-rose-100 mb-8">
        {status === 'correct' && (
          <div className="absolute top-0 left-0 w-full -mt-12 animate-bounce-in text-green-500 font-bold text-xl">
            Ch√≠nh x√°c! üéâ
          </div>
        )}
        
        <p className="text-slate-500 mb-4">H√£y g√µ t·ª´ ti·∫øng Anh cho:</p>
        <h3 className="text-3xl font-bold text-slate-800 mb-6">"{currentWord.vi}"</h3>
        
        {showHint && (
          <div className="mb-4 text-rose-500 font-mono bg-rose-50 py-2 rounded-lg animate-fade-in">
            G·ª£i √Ω: {currentWord.en.charAt(0)}...{currentWord.en.slice(-1)} ({currentWord.en.length} k√≠ t·ª±)
          </div>
        )}

        <form onSubmit={handleSubmit}>
          <input 
            ref={inputRef}
            type="text" 
            value={input}
            onChange={(e) => {
              setInput(e.target.value);
              setStatus('waiting');
            }}
            className={`w-full p-4 text-center text-lg font-bold border-2 rounded-xl outline-none transition-colors
              ${status === 'wrong' ? 'border-red-400 bg-red-50 text-red-600' : 'border-slate-200 focus:border-rose-400 focus:bg-rose-50'}
              ${status === 'correct' ? 'border-green-500 bg-green-50 text-green-700' : ''}
            `}
            placeholder="Nh·∫≠p t·ª´ ti·∫øng Anh..."
            autoFocus
          />
          <button type="submit" className="w-full mt-4 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition shadow-md shadow-rose-200">
            G·ª≠i
          </button>
        </form>
      </div>

      <div className="flex gap-4 justify-center">
        <button 
          onClick={() => { playSfx('click'); setShowHint(true);}}
          className="text-sm text-slate-400 hover:text-rose-500 underline"
        >
          Xem g·ª£i √Ω
        </button>
        <span className="text-slate-300">|</span>
        <button 
          onClick={handleGiveUp}
          className="text-sm text-slate-400 hover:text-rose-500 underline"
        >
          B·ªè qua t·ª´ n√†y
        </button>
      </div>
    </div>
  );
}
