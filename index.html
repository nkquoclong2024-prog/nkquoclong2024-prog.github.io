<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sàn Đấu Từ Vựng Tiếng Anh</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (Thay thế Lucide Icons để tránh lỗi trắng màn hình) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DỮ LIỆU TỪ VỰNG ---
        const rawData = [
          { id: 101, en: "fridge", vi: "tủ lạnh", pos: "noun (danh từ)" },
          { id: 102, en: "represent", vi: "đại diện", pos: "verb (động từ)" },
          { id: 103, en: "influence", vi: "ảnh hưởng", pos: "noun/verb" },
          { id: 104, en: "personality", vi: "tính cách cá nhân", pos: "noun (danh từ)" },
          { id: 105, en: "interests", vi: "sở thích cá nhân", pos: "noun (danh từ)" },
          { id: 106, en: "mindset", vi: "tư duy / nếp nghĩ", pos: "noun (danh từ)" },
          { id: 107, en: "detective", vi: "thám tử", pos: "noun (danh từ)" },
          { id: 108, en: "marriages", vi: "hôn nhân", pos: "noun (danh từ)" },
          { id: 109, en: "great-grandparents", vi: "ông bà cố", pos: "noun (danh từ)" },
          { id: 110, en: "relate", vi: "liên quan / có họ hàng", pos: "verb (động từ)" },
          { id: 111, en: "ancestor", vi: "tổ tiên", pos: "noun (danh từ)" },
          { id: 112, en: "generation", vi: "thế hệ", pos: "noun (danh từ)" },
          { id: 113, en: "genealogy", vi: "gia phả học", pos: "noun (danh từ)" },
          { id: 114, en: "take after", vi: "trông giống (ai đó)", pos: "phrasal verb" },
          { id: 115, en: "appearance", vi: "ngoại hình", pos: "noun (danh từ)" },
          { id: 116, en: "pass down", vi: "truyền lại / truyền xuống", pos: "phrasal verb" },
          { id: 117, en: "find out", vi: "tìm ra / khám phá", pos: "phrasal verb" },
          { id: 118, en: "niece", vi: "cháu gái (con của anh/chị)", pos: "noun (danh từ)" },
          { id: 119, en: "nephew", vi: "cháu trai (con của anh/chị)", pos: "noun (danh từ)" },
          { id: 120, en: "step-mother", vi: "mẹ kế", pos: "noun (danh từ)" },
          { id: 121, en: "slim", vi: "mảnh khảnh / thon thả", pos: "adj (tính từ)" },
          { id: 122, en: "overweight", vi: "thừa cân", pos: "adj (tính từ)" },
          { id: 123, en: "beard", vi: "râu", pos: "noun (danh từ)" },
          { id: 124, en: "jealous", vi: "ghen tị", pos: "adj (tính từ)" },
          { id: 125, en: "generous", vi: "hào phóng", pos: "adj (tính từ)" },
          { id: 126, en: "nervous", vi: "lo lắng", pos: "adj (tính từ)" },
          { id: 127, en: "scruffy", vi: "lôi thôi / luộm thuộm", pos: "adj (tính từ)" },
          { id: 1, en: "possess", vi: "sở hữu", pos: "verb (động từ)" },
          { id: 2, en: "boil", vi: "đun sôi", pos: "verb (động từ)" },
          { id: 3, en: "vegetarian", vi: "người ăn chay / món chay", pos: "noun/adj" },
          { id: 4, en: "Spain", vi: "Tây Ban Nha", pos: "noun (danh từ)" },
          { id: 5, en: "Portugal", vi: "Bồ Đào Nha", pos: "noun (danh từ)" },
          { id: 6, en: "airport", vi: "sân bay", pos: "noun (danh từ)" },
          { id: 7, en: "urgently", vi: "khẩn cấp", pos: "adv (phó từ)" },
          { id: 8, en: "reservation", vi: "đặt chỗ", pos: "noun (danh từ)" },
          { id: 9, en: "pieces", vi: "mảnh / miếng", pos: "noun (danh từ)" },
          { id: 10, en: "reusable bag", vi: "túi tái sử dụng", pos: "noun (danh từ)" },
          { id: 11, en: "food journal", vi: "nhật ký đồ ăn", pos: "noun (danh từ)" },
          { id: 12, en: "mints", vi: "kẹo bạc hà", pos: "noun (danh từ)" },
          { id: 13, en: "business cards", vi: "danh thiếp", pos: "noun (danh từ)" },
          { id: 14, en: "lip balm", vi: "son dưỡng môi", pos: "noun (danh từ)" },
          { id: 15, en: "a pair of glasses", vi: "cặp kính", pos: "noun phrase" },
          { id: 16, en: "deodorant", vi: "lăn khử mùi", pos: "noun (danh từ)" },
          { id: 17, en: "comb", vi: "chải đầu (v) / cái lược (n)", pos: "verb/noun" },
          { id: 18, en: "German", vi: "nước Đức / tiếng Đức", pos: "noun/adj" },
          { id: 19, en: "macho", vi: "đàn ông phong độ / nam tính", pos: "adj (tính từ)" },
          { id: 20, en: "convertibles", vi: "xe mui trần", pos: "noun (danh từ)" },
          { id: 21, en: "postcode", vi: "mã bưu chính", pos: "noun (danh từ)" },
          { id: 22, en: "at", vi: "@ (a còng)", pos: "symbol" },
          { id: 23, en: "four wheels", vi: "bốn bánh xe", pos: "noun phrase" },
          { id: 24, en: "six legs", vi: "sáu chân", pos: "noun phrase" },
          { id: 25, en: "a toothache", vi: "đau răng", pos: "noun (danh từ)" },
          { id: 26, en: "much time", vi: "nhiều thời gian", pos: "noun phrase" },
          { id: 27, en: "insect", vi: "côn trùng", pos: "noun (danh từ)" },
          { id: 28, en: "flat", vi: "căn hộ", pos: "noun (danh từ)" },
          { id: 29, en: "coke", vi: "coca cola / pepsi", pos: "noun (danh từ)" },
          { id: 30, en: "bowl", vi: "cái bát", pos: "noun (danh từ)" },
          { id: 31, en: "spoon", vi: "cái thìa", pos: "noun (danh từ)" },
          { id: 32, en: "croissant", vi: "bánh sừng bò", pos: "noun (danh từ)" },
          { id: 33, en: "sausage", vi: "xúc xích", pos: "noun (danh từ)" },
          { id: 34, en: "cereal", vi: "ngũ cốc", pos: "noun (danh từ)" },
          { id: 35, en: "mechanic", vi: "thợ sửa máy", pos: "noun (danh từ)" },
          { id: 36, en: "pilot", vi: "phi công", pos: "noun (danh từ)" },
          { id: 37, en: "artist", vi: "hoạ sĩ", pos: "noun (danh từ)" },
          { id: 38, en: "office worker", vi: "nhân viên văn phòng", pos: "noun (danh từ)" },
          { id: 39, en: "programmer", vi: "lập trình viên", pos: "noun (danh từ)" },
          { id: 40, en: "baker", vi: "người làm bánh", pos: "noun (danh từ)" },
          { id: 41, en: "scientist", vi: "nhà khoa học", pos: "noun (danh từ)" },
          { id: 42, en: "patient", vi: "bệnh nhân", pos: "noun (danh từ)" },
          { id: 43, en: "disease", vi: "bệnh tật / dịch bệnh", pos: "noun (danh từ)" },
          { id: 44, en: "coworker", vi: "đồng nghiệp", pos: "noun (danh từ)" },
          { id: 45, en: "have sth in common", vi: "có điểm chung", pos: "phrase" },
          { id: 46, en: "communicate", vi: "giao tiếp", pos: "verb (động từ)" },
          { id: 47, en: "pharmacist", vi: "dược sĩ", pos: "noun (danh từ)" },
          { id: 48, en: "staff", vi: "nhân viên", pos: "noun (danh từ)" },
          { id: 49, en: "administrator", vi: "quản lý / hành chính", pos: "noun (danh từ)" },
          { id: 50, en: "butter", vi: "bơ", pos: "noun (danh từ)" },
          { id: 51, en: "wine", vi: "rượu vang", pos: "noun (danh từ)" },
          { id: 52, en: "tin of tuna", vi: "cá ngừ đóng hộp", pos: "noun phrase" },
          { id: 53, en: "ugly", vi: "xấu xí", pos: "adj (tính từ)" },
          { id: 54, en: "depends", vi: "tuỳ thuộc / hên xui", pos: "verb (động từ)" },
          { id: 55, en: "permission", vi: "sự cho phép", pos: "noun (danh từ)" },
          { id: 56, en: "student cafeteria", vi: "căn tin sinh viên", pos: "noun (danh từ)" },
          { id: 57, en: "bean", vi: "đậu", pos: "noun (danh từ)" },
          { id: 58, en: "nursery", vi: "nhà trẻ / mẫu giáo", pos: "noun (danh từ)" },
          { id: 59, en: "anniversary", vi: "lễ kỷ niệm", pos: "noun (danh từ)" },
          { id: 60, en: "usual", vi: "như bình thường", pos: "adj (tính từ)" },
          { id: 61, en: "brilliant", vi: "tuyệt vời / xuất sắc", pos: "adj (tính từ)" },
          { id: 62, en: "politics", vi: "chính trị", pos: "noun (danh từ)" },
          { id: 63, en: "conversation", vi: "cuộc trò chuyện", pos: "noun (danh từ)" },
          { id: 64, en: "make some friends", vi: "kết bạn", pos: "verb phrase" },
          { id: 65, en: "pub", vi: "quán rượu", pos: "noun (danh từ)" },
          { id: 66, en: "ketchup", vi: "tương cà", pos: "noun (danh từ)" },
          { id: 67, en: "risky", vi: "mạo hiểm / rủi ro", pos: "adj (tính từ)" },
          { id: 68, en: "club", vi: "câu lạc bộ / hộp đêm", pos: "noun (danh từ)" },
          { id: 69, en: "bar", vi: "quán bar", pos: "noun (danh từ)" },
          { id: 70, en: "pillow", vi: "cái gối", pos: "noun (danh từ)" },
          { id: 71, en: "towel", vi: "khăn tắm", pos: "noun (danh từ)" },
          { id: 72, en: "elevator", vi: "thang máy", pos: "noun (danh từ)" },
          { id: 73, en: "escalator", vi: "thang cuốn", pos: "noun (danh từ)" },
          { id: 74, en: "terrace", vi: "sân thượng", pos: "noun (danh từ)" },
          { id: 75, en: "gourmet", vi: "sành ăn", pos: "adj (tính từ)" },
          { id: 76, en: "suitcase", vi: "va li", pos: "noun (danh từ)" },
          { id: 77, en: "cupboard", vi: "tủ đầu giường", pos: "noun (danh từ)" },
          { id: 78, en: "petrol station", vi: "trạm đổ xăng", pos: "noun (danh từ)" },
          { id: 79, en: "station", vi: "ga tàu", pos: "noun (danh từ)" },
          { id: 80, en: "pray", vi: "cầu nguyện", pos: "verb (động từ)" },
          { id: 81, en: "letters", vi: "lá thư", pos: "noun (danh từ)" },
          { id: 82, en: "medicine", vi: "thuốc", pos: "noun (danh từ)" },
          { id: 83, en: "mayor", vi: "thị trưởng", pos: "noun (danh từ)" },
          { id: 84, en: "rent", vi: "thuê", pos: "verb (động từ)" },
          { id: 85, en: "interval", vi: "khoảng nghỉ", pos: "noun (danh từ)" },
          { id: 86, en: "perfume", vi: "nước hoa", pos: "noun (danh từ)" },
          { id: 87, en: "property", vi: "bất động sản / tài sản", pos: "noun (danh từ)" },
          { id: 88, en: "thick", vi: "dày", pos: "adj (tính từ)" },
          { id: 89, en: "hard", vi: "cứng / khó", pos: "adj (tính từ)" },
          { id: 90, en: "scooter", vi: "xe tay ga", pos: "noun (danh từ)" },
          { id: 91, en: "awful", vi: "tồi tệ", pos: "adj (tính từ)" },
          { id: 92, en: "big pot of coffee", vi: "một ấm cà phê lớn", pos: "noun phrase" },
          { id: 93, en: "intentions", vi: "ý định", pos: "noun (danh từ)" },
          { id: 94, en: "prediction", vi: "dự đoán", pos: "noun (danh từ)" },
          { id: 95, en: "signal", vi: "tín hiệu / sóng", pos: "noun (danh từ)" },
          { id: 96, en: "bottom", vi: "đáy / ở dưới", pos: "noun (danh từ)" },
          { id: 97, en: "on the corner", vi: "ở góc", pos: "phrase" },
          { id: 98, en: "avenue", vi: "đại lộ", pos: "noun (danh từ)" },
          { id: 99, en: "straight on", vi: "đi thẳng", pos: "adv (phó từ)" },
          { id: 100, en: "steal", vi: "ăn trộm", pos: "verb (động từ)" }
        ];

        // --- AUDIO RESOURCES ---
        const MUSIC_URL = "https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-664.mp3";
        const SFX_CORRECT = "https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3";
        const SFX_WRONG = "https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3";
        const SFX_CLICK = "https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3";
        const SFX_WIN = "https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3";

        // --- COMPONENTS ---

        function VocabularyGame() {
            const [mode, setMode] = useState('menu'); 
            const [isMusicPlaying, setIsMusicPlaying] = useState(false);
            const audioRef = useRef(null);

            // State lưu danh sách ID các từ được chọn
            const [markedIds, setMarkedIds] = useState(() => {
                try {
                    const saved = localStorage.getItem('markedIds');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const validIds = parsed.filter(id => rawData.find(item => item.id === id));
                        if (validIds.length > 0) return validIds;
                    }
                } catch (e) {
                    console.error("Lỗi đọc localStorage (có thể do chế độ ẩn danh):", e);
                }
                return rawData.map(i => i.id);
            });

            const activeData = rawData.filter(item => markedIds.includes(item.id));

            // Lưu markedIds vào localStorage mỗi khi thay đổi
            useEffect(() => {
                try {
                    localStorage.setItem('markedIds', JSON.stringify(markedIds));
                } catch(e) {
                    // Bỏ qua lỗi nếu không lưu được
                }
            }, [markedIds]);

            // Khởi tạo Audio Nhạc nền
            useEffect(() => {
                audioRef.current = new Audio(MUSIC_URL);
                audioRef.current.loop = true;
                audioRef.current.volume = 0.2; 
                return () => {
                    if (audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current = null;
                    }
                };
            }, []);

            const toggleMusic = () => {
                if (!audioRef.current) return;
                if (isMusicPlaying) {
                    audioRef.current.pause();
                    setIsMusicPlaying(false);
                } else {
                    audioRef.current.play().catch(e => console.log("Playback error:", e));
                    setIsMusicPlaying(true);
                }
            };

            const playSfx = (type) => {
                let url = "";
                switch (type) {
                    case 'correct': url = SFX_CORRECT; break;
                    case 'wrong': url = SFX_WRONG; break;
                    case 'click': url = SFX_CLICK; break;
                    case 'win': url = SFX_WIN; break;
                    default: return;
                }
                const audio = new Audio(url);
                audio.volume = 0.5;
                audio.play().catch(() => {});
            };

            // Helper function to check if enough words are selected for games
            const checkDataRequirement = (minRequired) => {
                if (activeData.length < minRequired) {
                    alert(`Bạn cần chọn ít nhất ${minRequired} từ để chơi chế độ này! Hãy vào mục "Chọn từ" để thêm.`);
                    setMode('selection');
                    return false;
                }
                return true;
            };
            
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
                    {/* Header */}
                    <header className="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 className="text-lg md:text-2xl font-bold flex items-center gap-2 truncate cursor-pointer" onClick={() => setMode('menu')}>
                                <i className="fa-solid fa-book-open w-6"></i>
                                Vocabulary Quiz
                            </h1>
                            
                            <div className="flex items-center gap-3">
                                {/* Nút Chọn Từ nhanh */}
                                <button 
                                    onClick={() => setMode('selection')}
                                    className="flex items-center gap-1 bg-indigo-500 hover:bg-indigo-400 px-3 py-1.5 rounded-lg text-sm transition"
                                    title="Chọn từ vựng để học"
                                >
                                    <i className="fa-solid fa-gear"></i>
                                    <span className="hidden sm:inline">Chọn từ ({activeData.length})</span>
                                </button>

                                <button 
                                    onClick={toggleMusic}
                                    className={`p-2 rounded-full transition text-white border ${isMusicPlaying ? 'bg-indigo-500 border-indigo-400' : 'bg-indigo-700 border-indigo-600 opacity-70'}`}
                                    title={isMusicPlaying ? "Tắt nhạc" : "Bật nhạc"}
                                >
                                    {isMusicPlaying ? <i className="fa-solid fa-volume-high"></i> : <i className="fa-solid fa-volume-xmark"></i>}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 min-h-[80vh]">
                        {mode === 'menu' && (
                            <Menu 
                                setMode={(m) => {
                                    if (m === 'selection') { setMode(m); return; }
                                    if (m === 'quiz' && !checkDataRequirement(4)) return;
                                    if (m === 'match' && !checkDataRequirement(4)) return;
                                    if (m === 'memory' && !checkDataRequirement(2)) return;
                                    if (m === 'fill' && !checkDataRequirement(1)) return;
                                    if (activeData.length === 0) {
                                        alert("Bạn chưa chọn từ nào! Hãy vào mục 'Chọn từ' trước.");
                                        setMode('selection');
                                        return;
                                    }
                                    setMode(m);
                                }} 
                                playSfx={playSfx} 
                                activeCount={activeData.length}
                            />
                        )}

                        {mode === 'selection' && <WordSelectionMode allData={rawData} markedIds={markedIds} setMarkedIds={setMarkedIds} setMode={setMode} />}
                        
                        {/* Các chế độ chơi chỉ nhận activeData */}
                        {mode === 'study' && <StudyMode data={activeData} playSfx={playSfx} />}
                        {mode === 'memory' && <MemoryGameMode data={activeData} playSfx={playSfx} />}
                        {mode === 'match' && <MatchMode data={activeData} playSfx={playSfx} />}
                        {mode === 'quiz' && <QuizMode data={activeData} playSfx={playSfx} />}
                        {mode === 'typing' && <TypingMode data={activeData} playSfx={playSfx} />}
                        {mode === 'fill' && <FillBlanksMode data={activeData} playSfx={playSfx} />}
                    </main>
                </div>
            );
        }

        // --- Màn hình Chọn Từ (New) ---
        function WordSelectionMode({ allData, markedIds, setMarkedIds, setMode }) {
            const toggleId = (id) => {
                if (markedIds.includes(id)) {
                    setMarkedIds(prev => prev.filter(mid => mid !== id));
                } else {
                    setMarkedIds(prev => [...prev, id]);
                }
            };

            const selectAll = () => setMarkedIds(allData.map(i => i.id));
            const deselectAll = () => setMarkedIds([]);

            return (
                <div className="flex flex-col gap-6 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">Chọn từ vựng muốn học</h2>
                            <p className="text-slate-500 text-sm">Đã chọn: <span className="font-bold text-indigo-600">{markedIds.length}</span> / {allData.length}</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={selectAll} className="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-medium text-sm">Chọn tất cả</button>
                            <button onClick={deselectAll} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-medium text-sm">Bỏ chọn hết</button>
                            <button onClick={() => setMode('menu')} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md">Xong</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        {allData.map((item) => {
                            const isSelected = markedIds.includes(item.id);
                            return (
                                <div 
                                    key={item.id} 
                                    onClick={() => toggleId(item.id)}
                                    className={`flex items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${isSelected ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200 bg-white hover:border-slate-300'}`}
                                >
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center mr-3 ${isSelected ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-slate-300 bg-white'}`}>
                                        {isSelected && <i className="fa-solid fa-check text-xs"></i>}
                                    </div>
                                    <div>
                                        <div className={`font-bold ${isSelected ? 'text-indigo-900' : 'text-slate-500'}`}>{item.en}</div>
                                        <div className="text-xs text-slate-400">{item.vi}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="sticky bottom-4 w-full flex justify-center">
                        <button onClick={() => setMode('menu')} className="bg-slate-800 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-slate-900 transition flex items-center gap-2">
                            <i className="fa-solid fa-check"></i> Hoàn tất chọn từ
                        </button>
                    </div>
                </div>
            );
        }

        // --- Màn hình Menu ---
        function Menu({ setMode, playSfx, activeCount }) {
            const menuItems = [
                { id: 'selection', title: 'Chọn Từ Vựng', desc: `Đang chọn: ${activeCount} từ`, icon: 'fa-square-check', color: 'slate' },
                { id: 'study', title: 'Học Flashcard', desc: 'Có phát âm & loại từ', icon: 'fa-book-open', color: 'indigo' },
                { id: 'fill', title: 'Điền Ký Tự', desc: 'Điền chữ cái còn thiếu', icon: 'fa-pen', color: 'pink' },
                { id: 'memory', title: 'Ghép Thẻ Nhớ', desc: 'Lật hình tìm cặp giống nhau', icon: 'fa-shuffle', color: 'emerald' },
                { id: 'match', title: 'Nối Từ', desc: 'Nối từ Anh với nghĩa Việt', icon: 'fa-link', color: 'sky' },
                { id: 'quiz', title: 'Trắc Nghiệm', desc: 'Chọn 1 đáp án đúng trong 4', icon: 'fa-circle-question', color: 'orange' },
                { id: 'typing', title: 'Luyện Gõ', desc: 'Gõ lại từ tiếng Anh', icon: 'fa-keyboard', color: 'rose' },
            ];

            return (
                <div className="flex flex-col items-center justify-center mt-6 gap-6 animate-fade-in">
                    <div className="text-center mb-2">
                        <h2 className="text-2xl md:text-3xl font-bold text-indigo-900 mb-2">Sàn đấu từ vựng</h2>
                        <p className="text-slate-500">Bạn đang học <span className="font-bold text-indigo-600">{activeCount}</span> từ vựng.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                        {menuItems.map((item) => (
                        <button 
                            key={item.id}
                            onClick={() => { playSfx('click'); setMode(item.id); }}
                            className={`group relative overflow-hidden bg-white border-2 p-6 rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 text-left flex items-start gap-4
                            ${item.color === 'slate' ? 'border-slate-200 hover:border-slate-500 bg-slate-50' : ''}
                            ${item.color === 'indigo' ? 'border-indigo-100 hover:border-indigo-500' : ''}
                            ${item.color === 'pink' ? 'border-pink-100 hover:border-pink-500' : ''}
                            ${item.color === 'emerald' ? 'border-emerald-100 hover:border-emerald-500' : ''}
                            ${item.color === 'sky' ? 'border-sky-100 hover:border-sky-500' : ''}
                            ${item.color === 'orange' ? 'border-orange-100 hover:border-orange-500' : ''}
                            ${item.color === 'rose' ? 'border-rose-100 hover:border-rose-500' : ''}
                            `}
                        >
                            <div className={`
                            w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 transition-colors
                            ${item.color === 'slate' ? 'bg-slate-200 text-slate-600 group-hover:bg-slate-600 group-hover:text-white' : ''}
                            ${item.color === 'indigo' ? 'bg-indigo-100 text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white' : ''}
                            ${item.color === 'pink' ? 'bg-pink-100 text-pink-600 group-hover:bg-pink-600 group-hover:text-white' : ''}
                            ${item.color === 'emerald' ? 'bg-emerald-100 text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white' : ''}
                            ${item.color === 'sky' ? 'bg-sky-100 text-sky-600 group-hover:bg-sky-600 group-hover:text-white' : ''}
                            ${item.color === 'orange' ? 'bg-orange-100 text-orange-600 group-hover:bg-orange-600 group-hover:text-white' : ''}
                            ${item.color === 'rose' ? 'bg-rose-100 text-rose-600 group-hover:bg-rose-600 group-hover:text-white' : ''}
                            `}>
                                <i className={`fa-solid ${item.icon} text-xl`}></i>
                            </div>
                            <div>
                            <h3 className="text-lg font-bold text-slate-800">{item.title}</h3>
                            <p className="text-slate-500 text-sm mt-1">{item.desc}</p>
                            </div>
                        </button>
                        ))}
                    </div>
                </div>
            );
        }

        // --- Chế độ 1: Flashcards (Đã cập nhật phát âm + POS) ---
        function StudyMode({ data, playSfx }) {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            useEffect(() => {
                setCurrentIndex(0);
                setIsFlipped(false);
            }, [data]);

            if (data.length === 0) return <div className="text-center p-8">Chưa có từ nào được chọn!</div>;

            const currentWord = data[currentIndex];

            const nextCard = () => {
                playSfx('click');
                setIsFlipped(false);
                setTimeout(() => setCurrentIndex((prev) => (prev + 1) % data.length), 200);
            };
            
            const prevCard = () => {
                playSfx('click');
                setIsFlipped(false);
                setTimeout(() => setCurrentIndex((prev) => (prev - 1 + data.length) % data.length), 200);
            };

            const handleFlip = () => {
                playSfx('click');
                setIsFlipped(!isFlipped);
            };

            const handleSpeak = (e, text) => {
                e.stopPropagation(); 
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9; 
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("Trình duyệt của bạn không hỗ trợ đọc âm thanh.");
                }
            };

            return (
                <div className="flex flex-col items-center mt-6 max-w-xl mx-auto">
                    <div className="w-full mb-4 flex justify-between text-slate-500 text-sm">
                        <span>Thẻ {currentIndex + 1}/{data.length}</span>
                        <span>Chạm để lật</span>
                    </div>
                    
                    <div onClick={handleFlip} className="perspective-1000 w-full h-72 cursor-pointer group">
                        <div className={`relative w-full h-full transition-transform duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                            
                            <div className="absolute inset-0 backface-hidden bg-white border-2 border-indigo-200 rounded-3xl shadow-lg flex flex-col items-center justify-center p-6 relative">
                                <span className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-4">Tiếng Anh</span>
                                <h3 className="text-4xl font-bold text-slate-800 text-center mb-6">{currentWord.en}</h3>
                                
                                <button 
                                    onClick={(e) => handleSpeak(e, currentWord.en)}
                                    className="absolute bottom-6 right-6 w-12 h-12 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center transition shadow-sm hover:scale-110"
                                    title="Nghe phát âm"
                                >
                                    <i className="fa-solid fa-volume-high text-xl"></i>
                                </button>
                            </div>

                            <div className="absolute inset-0 backface-hidden rotate-y-180 bg-indigo-600 text-white rounded-3xl shadow-lg flex flex-col items-center justify-center p-6">
                                <span className="text-xs font-bold text-indigo-200 uppercase tracking-wider mb-2">Nghĩa Tiếng Việt</span>
                                <span className="inline-block px-3 py-1 bg-indigo-700 rounded-full text-xs md:text-sm font-mono text-indigo-200 mb-3 border border-indigo-500">
                                    {currentWord.pos}
                                </span>
                                <h3 className="text-3xl font-bold text-center">{currentWord.vi}</h3>
                            </div>

                        </div>
                    </div>

                    <div className="flex gap-4 mt-8 w-full">
                        <button onClick={prevCard} className="flex-1 py-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 font-semibold text-slate-600">Quay lại</button>
                        <button onClick={nextCard} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-semibold shadow-lg shadow-indigo-200">Tiếp theo</button>
                    </div>
                </div>
            );
        }

        // --- Chế độ 6: Điền Ký Tự (New) ---
        function FillBlanksMode({ data, playSfx }) {
            const [queue, setQueue] = useState([]);
            const [currentWord, setCurrentWord] = useState(null);
            const [maskedIndices, setMaskedIndices] = useState([]);
            const [inputs, setInputs] = useState({});
            const [status, setStatus] = useState('playing'); // playing, correct, wrong
            const [showResult, setShowResult] = useState(false);

            // Khởi tạo game: Trộn và lấy 10 từ
            useEffect(() => {
                setQueue([...data].sort(() => 0.5 - Math.random()).slice(0, 10));
            }, [data]);

            // Khi queue thay đổi, thiết lập từ hiện tại
            useEffect(() => {
                if (queue.length > 0) {
                    setupWord(queue[0]);
                }
            }, [queue]);

            const setupWord = (word) => {
                const len = word.en.length;
                // Che khoảng 40% ký tự, ít nhất 1 ký tự
                const numToMask = Math.max(1, Math.floor(len * 0.4));
                const indices = Array.from({ length: len }, (_, i) => i);
                // Trộn index và lấy n cái đầu
                const masked = indices.sort(() => 0.5 - Math.random()).slice(0, numToMask);
                
                setCurrentWord(word);
                setMaskedIndices(masked);
                setInputs({});
                setStatus('playing');
                setShowResult(false);
            };

            const handleInputChange = (index, value) => {
                if (status !== 'playing') return;
                
                // Chỉ lấy ký tự cuối cùng nhập vào
                const char = value.slice(-1);
                
                setInputs(prev => ({
                    ...prev,
                    [index]: char
                }));

                // Tự động focus sang ô tiếp theo nếu có
                if (char && maskedIndices.includes(index)) {
                    const currentInput = document.querySelector(`input[data-index="${index}"]`);
                    if (currentInput) {
                        let next = currentInput.nextElementSibling;
                        while(next) {
                            if (next.tagName === 'INPUT' && !next.disabled) {
                                next.focus();
                                break;
                            }
                            next = next.nextElementSibling;
                        }
                    }
                }
            };

            const checkAnswer = () => {
                const fullWord = currentWord.en.toLowerCase();
                let isCorrect = true;

                maskedIndices.forEach(idx => {
                    const inputChar = (inputs[idx] || '').toLowerCase();
                    const actualChar = fullWord[idx];
                    if (inputChar !== actualChar) isCorrect = false;
                });

                if (isCorrect) {
                    playSfx('correct');
                    setStatus('correct');
                    setTimeout(() => {
                        setQueue(prev => prev.slice(1));
                    }, 1000);
                } else {
                    playSfx('wrong');
                    setStatus('wrong');
                    setShowResult(true); // Hiện đáp án đúng nếu sai
                }
            };

            const handleNext = () => {
                setQueue(prev => prev.slice(1));
            }

            if (queue.length === 0) return (
                <div className="text-center mt-10 animate-fade-in">
                    <div className="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 text-pink-500">
                        <i className="fa-solid fa-check text-4xl"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800">Hoàn thành!</h2>
                    <p className="text-slate-500 mb-6">Bạn đã hoàn thành bài tập điền từ.</p>
                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-800 text-white rounded-lg">Về trang chủ</button>
                </div>
            );

            if (!currentWord) return <div>Loading...</div>;

            return (
                <div className="max-w-md mx-auto mt-6 flex flex-col gap-6">
                    <div className="text-center mb-2">
                        <span className="text-sm font-bold text-pink-500 uppercase tracking-widest">Điền ký tự còn thiếu</span>
                        <div className="text-xs text-slate-400 mt-1">Còn lại: {queue.length} từ</div>
                    </div>

                    <div className="bg-white p-8 rounded-3xl shadow-lg border-b-4 border-slate-100 text-center relative">
                        <h3 className="text-lg text-slate-500 mb-2">Nghĩa tiếng Việt:</h3>
                        <p className="text-2xl font-bold text-slate-800 mb-8">{currentWord.vi}</p>

                        {/* Word Display */}
                        <div className="flex flex-wrap justify-center gap-2 mb-8">
                            {currentWord.en.split('').map((char, index) => {
                                const isMasked = maskedIndices.includes(index);
                                
                                if (isMasked) {
                                    return (
                                        <input
                                            key={index}
                                            data-index={index}
                                            type="text"
                                            maxLength={1}
                                            value={inputs[index] || ''}
                                            onChange={(e) => handleInputChange(index, e.target.value)}
                                            disabled={status !== 'playing'}
                                            className={`w-10 h-12 text-center text-xl font-bold border-b-4 outline-none rounded-t-md transition-colors
                                                ${status === 'correct' ? 'border-green-500 bg-green-50 text-green-700' : ''}
                                                ${status === 'wrong' ? 'border-red-500 bg-red-50 text-red-700' : ''}
                                                ${status === 'playing' ? 'border-slate-300 bg-slate-50 focus:border-pink-500 focus:bg-white' : ''}
                                            `}
                                        />
                                    );
                                }
                                return (
                                    <div key={index} className="w-10 h-12 flex items-center justify-center text-xl font-bold text-slate-400 border-b-4 border-transparent">
                                        {char}
                                    </div>
                                );
                            })}
                        </div>

                        {status === 'playing' && (
                            <button onClick={checkAnswer} className="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-xl transition shadow-md">
                                Kiểm tra
                            </button>
                        )}

                        {status === 'wrong' && (
                            <div className="animate-fade-in">
                                <p className="text-red-500 mb-4 font-bold">Sai rồi! Đáp án đúng là: <span className="text-slate-800 text-xl">{currentWord.en}</span></p>
                                <button onClick={handleNext} className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-900">
                                    Câu tiếp theo <i className="fa-solid fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        )}
                        
                        {status === 'correct' && (
                                <div className="animate-bounce-in text-green-600 font-bold text-lg">
                                    Chính xác! Đang chuyển...
                                </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Chế độ 2: Memory Game (Lật hình) ---
        function MemoryGameMode({ data, playSfx }) {
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [matched, setMatched] = useState([]);
            const [moves, setMoves] = useState(0);
            const [won, setWon] = useState(false);

            useEffect(() => startNewGame(), []);

            const startNewGame = () => {
                // Chỉ lấy tối đa 6 cặp để chơi cho đỡ rối, nhưng phải lấy từ danh sách đã chọn (data)
                const subset = [...data].sort(() => 0.5 - Math.random()).slice(0, 6);
                const deck = subset.flatMap(item => [
                    { id: item.id, content: item.en, type: 'en', key: `${item.id}-en` },
                    { id: item.id, content: item.vi, type: 'vi', key: `${item.id}-vi` }
                ]).sort(() => 0.5 - Math.random());
                setCards(deck);
                setFlipped([]);
                setMatched([]);
                setMoves(0);
                setWon(false);
            };

            const handleClick = (card) => {
                if (won || flipped.length >= 2 || flipped.includes(card) || matched.includes(card.id)) return;
                
                playSfx('click');
                const newFlipped = [...flipped, card];
                setFlipped(newFlipped);
                
                if (newFlipped.length === 2) {
                    setMoves(m => m + 1);
                    if (newFlipped[0].id === newFlipped[1].id) {
                        playSfx('correct');
                        setMatched(m => [...m, newFlipped[0].id]);
                        setFlipped([]);
                        if (matched.length + 1 === cards.length / 2) {
                            setTimeout(() => { playSfx('win'); setWon(true); }, 500);
                        }
                    } else {
                        setTimeout(() => { playSfx('wrong'); setFlipped([]); }, 1000);
                    }
                }
            };

            if (data.length < 2) return <div className="p-8 text-center text-red-500">Cần ít nhất 2 từ vựng để chơi game này!</div>;

            return (
                <div className="flex flex-col items-center">
                    <div className="flex justify-between w-full max-w-2xl mb-4">
                        <span className="font-bold text-slate-600">Số lượt: {moves}</span>
                        <button onClick={() => { playSfx('click'); startNewGame();}} className="text-emerald-600 font-bold flex gap-2 items-center"><i className="fa-solid fa-rotate-left"></i> Chơi lại</button>
                    </div>
                    
                    <div className="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full max-w-2xl">
                        {cards.map(card => {
                            const isOpen = flipped.includes(card) || matched.includes(card.id);
                            const isMatch = matched.includes(card.id);
                            return (
                                <div key={card.key} onClick={() => handleClick(card)} 
                                    className={`aspect-[4/3] flex items-center justify-center text-center p-2 rounded-xl cursor-pointer transition-all duration-300 transform hover:scale-105 shadow-sm
                                    ${isMatch ? 'bg-emerald-100 text-emerald-700 border-2 border-emerald-200 opacity-60' : 
                                        isOpen ? 'bg-emerald-600 text-white shadow-md' : 'bg-white border-2 border-slate-200 text-transparent hover:border-emerald-200'}
                                    `}>
                                    <span className={isOpen ? 'text-xs sm:text-sm font-semibold animate-fade-in' : 'hidden'}>{card.content}</span>
                                </div>
                            );
                        })}
                    </div>
                    
                    {won && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 px-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl text-center animate-bounce-in max-w-sm w-full">
                                <i className="fa-solid fa-trophy text-5xl text-yellow-500 mb-4"></i>
                                <h2 className="text-2xl font-bold mb-2">Chiến thắng!</h2>
                                <p className="mb-6 text-slate-500">Bạn chỉ mất {moves} lượt để hoàn thành.</p>
                                <button onClick={() => { playSfx('click'); startNewGame();}} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">Chơi ván mới</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Chế độ 3: Match Mode (Nối từ) ---
        function MatchMode({ data, playSfx }) {
            const [leftItems, setLeftItems] = useState([]);
            const [rightItems, setRightItems] = useState([]);
            const [selected, setSelected] = useState(null); 
            const [matched, setMatched] = useState([]); 
            const [wrongPair, setWrongPair] = useState([]); 
            const [won, setWon] = useState(false);

            useEffect(() => startNewGame(), []);

            const startNewGame = () => {
                // Cần tối thiểu 4 từ
                const safeSize = Math.min(data.length, 5);
                const subset = [...data].sort(() => 0.5 - Math.random()).slice(0, safeSize);
                
                setLeftItems([...subset].sort(() => 0.5 - Math.random()));
                setRightItems([...subset].sort(() => 0.5 - Math.random()));
                setMatched([]);
                setSelected(null);
                setWrongPair([]);
                setWon(false);
            };

            const handleSelect = (item, side) => {
                if (matched.includes(item.id) || wrongPair.length > 0) return;

                playSfx('click');

                if (!selected) {
                    setSelected({ id: item.id, side });
                    return;
                }

                if (selected.id === item.id && selected.side === side) {
                    setSelected(null);
                    return;
                }

                if (selected.side === side) {
                    setSelected({ id: item.id, side });
                    return;
                }

                if (selected.id === item.id) {
                    playSfx('correct');
                    const newMatched = [...matched, item.id];
                    setMatched(newMatched);
                    setSelected(null);
                    
                    if (newMatched.length === leftItems.length) {
                        setTimeout(() => { playSfx('win'); setWon(true); }, 500);
                    }
                } else {
                    playSfx('wrong');
                    setWrongPair([selected.id, item.id]); 
                    setSelected(null);
                    setTimeout(() => setWrongPair([]), 800); 
                }
            };

            return (
                <div className="flex flex-col items-center w-full">
                    <div className="flex justify-between w-full max-w-3xl mb-4 px-2">
                        <span className="font-bold text-slate-600">Ghép cặp đúng</span>
                        <button onClick={() => { playSfx('click'); startNewGame();}} className="text-sky-600 font-bold flex gap-2 items-center"><i className="fa-solid fa-rotate-left"></i> Đổi từ khác</button>
                    </div>

                    <div className="grid grid-cols-2 gap-4 md:gap-8 w-full max-w-3xl">
                        <div className="flex flex-col gap-3">
                            {leftItems.map(item => {
                                const isMatched = matched.includes(item.id);
                                const isSelected = selected?.id === item.id && selected?.side === 'left';
                                const isWrong = wrongPair.includes(item.id) && !isMatched; 

                                return (
                                <button
                                    key={item.id}
                                    onClick={() => handleSelect(item, 'left')}
                                    disabled={isMatched}
                                    className={`
                                    p-3 md:p-4 rounded-xl border-2 text-center font-medium transition-all duration-300 relative
                                    ${isMatched ? 'opacity-0 pointer-events-none' : 'opacity-100'}
                                    ${isSelected 
                                        ? 'bg-sky-100 border-sky-500 text-sky-800 scale-105 shadow-md z-10' 
                                        : 'bg-white border-slate-200 hover:border-sky-300'}
                                    ${isWrong ? 'animate-shake bg-red-50 border-red-400 text-red-600' : ''}
                                    `}
                                >
                                    {item.en}
                                </button>
                                );
                            })}
                        </div>

                        <div className="flex flex-col gap-3">
                            {rightItems.map(item => {
                                const isMatched = matched.includes(item.id);
                                const isSelected = selected?.id === item.id && selected?.side === 'right';
                                const isWrong = wrongPair.includes(item.id) && !isMatched;

                                return (
                                <button
                                    key={item.id}
                                    onClick={() => handleSelect(item, 'right')}
                                    disabled={isMatched}
                                    className={`
                                    p-3 md:p-4 rounded-xl border-2 text-center font-medium transition-all duration-300
                                    ${isMatched ? 'opacity-0 pointer-events-none' : 'opacity-100'}
                                    ${isSelected 
                                        ? 'bg-sky-100 border-sky-500 text-sky-800 scale-105 shadow-md z-10' 
                                        : 'bg-white border-slate-200 hover:border-sky-300'}
                                    ${isWrong ? 'animate-shake bg-red-50 border-red-400 text-red-600' : ''}
                                    `}
                                >
                                    {item.vi}
                                </button>
                                );
                            })}
                        </div>
                    </div>

                    {won && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 px-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl text-center animate-bounce-in max-w-sm w-full">
                                <i className="fa-solid fa-trophy text-5xl text-yellow-500 mb-4"></i>
                                <h2 className="text-2xl font-bold mb-2">Xuất sắc!</h2>
                                <p className="mb-6 text-slate-500">Bạn đã nối đúng tất cả các cặp.</p>
                                <button onClick={() => { playSfx('click'); startNewGame();}} className="w-full py-3 bg-sky-600 text-white rounded-xl font-bold hover:bg-sky-700">Chơi tiếp</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Chế độ 4: Trắc Nghiệm (Quiz) ---
        function QuizMode({ data, playSfx }) {
            const [currentQ, setCurrentQ] = useState(0);
            const [score, setScore] = useState(0);
            const [questions, setQuestions] = useState([]);
            const [selected, setSelected] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [finished, setFinished] = useState(false);

            useEffect(() => restartQuiz(), []);

            const restartQuiz = () => {
                // Cần ít nhất 4 từ để tạo đáp án nhiễu
                if (data.length < 4) return;

                const shuffled = [...data].sort(() => 0.5 - Math.random());
                const qs = shuffled.map(item => {
                    // Lấy các từ khác làm đáp án nhiễu từ chính tập data đã chọn
                    const distractors = data.filter(d => d.id !== item.id).sort(() => 0.5 - Math.random()).slice(0, 3);
                    const options = [...distractors, item].sort(() => 0.5 - Math.random());
                    return { target: item, options };
                });
                setQuestions(qs);
                setCurrentQ(0);
                setScore(0);
                setSelected(null);
                setIsCorrect(null);
                setFinished(false);
            };

            const handleSelect = (option) => {
                if (selected) return; 
                setSelected(option);
                const correct = option.id === questions[currentQ].target.id;
                setIsCorrect(correct);
                
                if (correct) {
                    playSfx('correct');
                    setScore(s => s + 1);
                } else {
                    playSfx('wrong');
                }
            };

            const nextQuestion = () => {
                playSfx('click');
                if (currentQ + 1 < questions.length) {
                    setCurrentQ(c => c + 1);
                    setSelected(null);
                    setIsCorrect(null);
                } else {
                    playSfx('win');
                    setFinished(true);
                }
            };

            if (data.length < 4) return <div className="p-8 text-center text-red-500">Cần ít nhất 4 từ vựng để tạo câu hỏi trắc nghiệm!</div>;
            if (questions.length === 0) return <div>Loading...</div>;
            
            if (finished) return (
                <div className="text-center max-w-md mx-auto mt-10 p-8 bg-white rounded-3xl shadow-lg">
                    <i className="fa-solid fa-trophy text-5xl text-orange-500 mb-4"></i>
                    <h2 className="text-2xl font-bold text-slate-800">Kết quả</h2>
                    <p className="text-lg text-slate-600 mt-2">Bạn đúng <span className="font-bold text-orange-600">{score}/{questions.length}</span> câu.</p>
                    <button onClick={() => { playSfx('click'); restartQuiz();}} className="mt-8 w-full py-3 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 transition">Làm lại bài thi</button>
                </div>
            );

            const q = questions[currentQ];

            return (
                <div className="max-w-xl mx-auto flex flex-col gap-6 mt-4">
                    <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                        <div className="bg-orange-500 h-full transition-all duration-300" style={{ width: `${((currentQ + 1) / questions.length) * 100}%` }}></div>
                    </div>

                    <div className="bg-white p-8 rounded-2xl shadow-sm text-center border-2 border-orange-50">
                        <span className="text-xs font-bold text-orange-400 uppercase">Câu hỏi {currentQ + 1}</span>
                        <h3 className="text-2xl font-bold text-slate-800 mt-2 mb-6">"{q.target.vi}" nghĩa tiếng Anh là gì?</h3>
                        
                        <div className="grid grid-cols-1 gap-3">
                            {q.options.map((opt) => {
                                let btnClass = "p-4 rounded-xl border-2 font-medium transition-all text-left relative ";
                                if (selected) {
                                    if (opt.id === q.target.id) btnClass += "bg-green-100 border-green-500 text-green-800 "; 
                                    else if (opt === selected && opt.id !== q.target.id) btnClass += "bg-red-100 border-red-500 text-red-800 "; 
                                    else btnClass += "bg-slate-50 border-slate-100 opacity-50 ";
                                } else {
                                    btnClass += "bg-white border-slate-200 hover:border-orange-300 hover:bg-orange-50 cursor-pointer";
                                }

                                return (
                                    <button key={opt.id} onClick={() => handleSelect(opt)} className={btnClass} disabled={!!selected}>
                                        {opt.en}
                                        {selected && opt.id === q.target.id && <i className="fa-solid fa-check absolute right-4 top-4 text-green-600 text-xl"></i>}
                                        {selected && opt === selected && opt.id !== q.target.id && <i className="fa-solid fa-xmark absolute right-4 top-4 text-red-600 text-xl"></i>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {selected && (
                        <button onClick={nextQuestion} className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 shadow-lg flex items-center justify-center gap-2 animate-fade-in">
                            {currentQ + 1 === questions.length ? "Xem kết quả" : "Câu tiếp theo"} <i className="fa-solid fa-arrow-right"></i>
                        </button>
                    )}
                </div>
            );
        }

        // --- Chế độ 5: Luyện Gõ (Typing) ---
        function TypingMode({ data, playSfx }) {
            const [queue, setQueue] = useState([]);
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('waiting'); 
            const [showHint, setShowHint] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => {
                // Chỉ lấy 10 từ ngẫu nhiên từ danh sách đã chọn
                setQueue([...data].sort(() => 0.5 - Math.random()).slice(0, 10));
            }, [data]);

            if (queue.length === 0 && data.length > 0) return <div>Loading...</div>;
            if (data.length === 0) return <div>Chưa có từ nào được chọn!</div>;

            const currentWord = queue[0];

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!currentWord) return;

                if (input.trim().toLowerCase() === currentWord.en.toLowerCase()) {
                    playSfx('correct');
                    setStatus('correct');
                    setTimeout(() => {
                        setQueue(prev => prev.slice(1));
                        setInput('');
                        setStatus('waiting');
                        setShowHint(false);
                    }, 1000);
                } else {
                    playSfx('wrong');
                    setStatus('wrong');
                }
            };

            const handleGiveUp = () => {
                playSfx('click');
                setInput(currentWord.en);
                setStatus('giveup'); 
                setTimeout(() => {
                    setQueue(prev => prev.slice(1));
                    setInput('');
                    setStatus('waiting');
                    setShowHint(false);
                }, 1500);
            }

            if (queue.length === 0) return (
                <div className="text-center mt-10 animate-fade-in">
                    <div className="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500">
                        <i className="fa-solid fa-check text-4xl"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800">Hoàn thành!</h2>
                    <p className="text-slate-500 mb-6">Bạn đã luyện gõ hết bộ từ này.</p>
                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-800 text-white rounded-lg">Về trang chủ</button>
                </div>
            );

            return (
                <div className="max-w-md mx-auto mt-6 flex flex-col gap-6">
                    <div className="text-center mb-2">
                        <span className="text-sm font-bold text-rose-400 uppercase tracking-widest">Thử thách chính tả</span>
                        <div className="text-xs text-slate-400 mt-1">Còn lại: {queue.length} từ</div>
                    </div>

                    <div className="bg-white p-8 rounded-3xl shadow-lg border-b-4 border-slate-100 text-center relative overflow-hidden">
                        {status === 'correct' && <div className="absolute inset-0 bg-green-100 flex items-center justify-center text-green-700 font-bold text-xl animate-fade-in">Chính xác! 🎉</div>}
                        
                        <h3 className="text-xl text-slate-500 mb-2">Hãy gõ từ tiếng Anh cho:</h3>
                        <p className="text-3xl font-bold text-slate-800 mb-6">"{currentWord.vi}"</p>

                        {showHint && (
                        <div className="mb-4 text-sm text-rose-500 font-mono bg-rose-50 p-2 rounded inline-block">
                            Gợi ý: {currentWord.en.charAt(0)}...{currentWord.en.slice(-1)} ({currentWord.en.length} kí tự)
                        </div>
                        )}

                        <form onSubmit={handleSubmit} className="relative">
                            <input 
                                ref={inputRef}
                                type="text" 
                                value={input}
                                onChange={(e) => { setInput(e.target.value); setStatus('waiting'); }}
                                className={`w-full p-4 text-center text-lg font-bold border-2 rounded-xl outline-none transition-colors
                                ${status === 'wrong' ? 'border-red-400 bg-red-50 text-red-600' : 'border-slate-200 focus:border-rose-400 focus:bg-rose-50'}
                                `}
                                placeholder="Nhập từ tiếng Anh..."
                                autoFocus
                            />
                            <button type="submit" className="absolute right-2 top-2 bottom-2 bg-rose-500 hover:bg-rose-600 text-white px-4 rounded-lg font-bold transition">
                                Gửi
                            </button>
                        </form>

                        <div className="flex justify-center gap-4 mt-6">
                            <button onClick={() => { playSfx('click'); setShowHint(true);}} className="text-sm text-slate-400 hover:text-rose-500 underline">Xem gợi ý</button>
                            <span className="text-slate-300">|</span>
                            <button onClick={handleGiveUp} className="text-sm text-slate-400 hover:text-slate-600 underline">Bỏ qua từ này</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VocabularyGame />);
    </script>
</body>
</html>
